<html>
<head>
    <!-- Include the required JavaScript libraries: -->
    <script src='@{controllers.ead.routes.Assets.at("fancytree/jquery/jquery.js"}' type="text/javascript"></script>
    <script src='@{controllers.ead.routes.Assets.at("fancytree/jquery/jquery-ui.custom.js"}' type="text/javascript"></script>
    <script src='@{controllers.ead.routes.Assets.at("fancytree/jquery/jquery.cookie.js"}' type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="@{routes.Assets.at("common/stylesheets/bootstrap.min.css")}"/>
    <link rel='stylesheet' type='text/css' href='@{controllers.ead.routes.Assets.at("fancytree/skin-lion/ui.fancytree.css")}'>
    <script src='@{controllers.ead.routes.Assets.at("fancytree/jquery.fancytree.js")}' type="text/javascript"></script>
    <script src='@{controllers.ead.routes.Assets.at("fancytree/jquery.fancytree.filter.js")}' type="text/javascript"></script>

    <script src='@{controllers.ead.routes.Assets.at("javascripts/mustache.js")}' type="text/javascript"></script>

    <style>
        body {
            margin: 20px;
        }
        input[type='text'] {
            height: auto;
        }
        .fancytree-container {
            background: #eaeaea;
            height: auto;
        }
    </style>

    <!-- Add code to initialize the tree when the document is loaded: -->
    <script type="text/javascript">
        $(document).ready(function () {
            // Attach the fancytree widget to an existing <div id="tree"> element
            // and pass the tree options as an argument to the fancytree() function:
            $("#tree").fancytree({
                // why is this here? it never gets triggered it seems.
                onActivate: function(node) {
                    // A DynaTreeNode object is passed to the activation handler
                    // Note: we also get this event, if persistence is on, and the page is reloaded.
                    alert("You activated " + node.data.title);
                },
                persist: true,
                clickFolderMode: 3,
                source: {
                    url: '@{controllers.ead.routes.Prototype.tree(scala.Option.apply(null), true)}'
                },
                extensions: ["filter"],
                filter: {
                    mode: "hide"
                },
                // lazyload is also never triggered.
                lazyload: function(e, data) {
                    data.result = {
                      url: '@{controllers.ead.routes.Prototype.tree(scala.Option.apply(null), true)}',
                      data: {path: data.node.key}
                    };
                },
                activate: function(e, data) {

                    var node = data.node;
                    if (node.data.path) {
                        // here we can now render the detail
                        // we need to be able to render different parts of the APENet EAD tree, case-by-case
                        var handledKeys = {
                            "/": "eadheaderTpl",
                            "/ead/archdesc/dsc/c/c[0]/c": "eadarchdescTpl",
                            "/ead/archdesc": "testTmpl"
                        };

                        if (handledKeys[node.data.path]) {
                            $.getJSON('/experiments/ead/sourceTree', { path: node.data.path }, function(data) {
                                var template = $('#' + handledKeys[node.data.path]).html();
                                var html = Mustache.to_html(template, data);
                                if(node.data.path === "/"){
                                      $("#header").html(html);
                                }
                                else {
                                    $('#detail').html(html);
                                }
                                console.log(node.data.path);

                                
                            });
                        } else {
                            $('#detail').html('<p>Hello, Is there anybody in there? / Just nod if you can hear me / Is there anyone home?</p><p>' + node.data.path +'</p>')
                        }
                    }
                }

            });

            var tree = $("#tree").fancytree("getTree");

            $("input[name=search]").keyup(function(e){
              var match = $(this).val();
              if(e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === ""){
                $("button#btnResetSearch").click();
                return;
              }
              // Pass text as filter string (will be matched as substring in the node title)
              var n = tree.applyFilter(match);
              $("button#btnResetSearch").attr("disabled", false);
              $("span#matches").text("(" + n + " matches)");
            }).focus();

            $("button#btnResetSearch").click(function(e){
              $("input[name=search]").val("");
              $("span#matches").text("");
              tree.clearFilter();
            }).attr("disabled", true);
        })
    </script>


</head>
<body>

<div class="container">
    <div class="row">
         <div class="span12">
             <form class="form-horizontal">
                    <label for="search">Filter:</label>
                        <input class="span2" type="text" name="search" id="search" placeholder="Filter...">
                        <button id="btnResetSearch" class="btn" type="submit">&times;</button>
                        <span id="matches"></span>
             </form>
         </div>
    </div>
    <div class="row">
        <div class="span5">
            <div id="tree"></div>
        </div>
        <div class="span7">
            <div id="header"></div>
            <div id="detail"></div>
        </div>
    </div>
</div>



</body>
</html>



<script id="eadheaderTpl" type="text/template">
    <h2>Header Template</h2>
    <dl class="dl-horizontal">
        <dt>Title:</dt>
            <dd>{{ead.eadheader.filedesc.titlestmt.titleproper}}</dd>
        <dt>Creator:</dt>
            <dd>{{ead.eadheader.filedesc.titlestmt.author}}</dd>
        <dt>Identifier:</dt>
            <dd>{{ead.eadheader.identifier}}</dd>
        <dt>Origin</dt>
            <dd>{{ead.archdesc.did.origination.corpname}}</dd>
        <dt>Arrangement</dt>
            <dd>{{ead.archdesc.arrangement.p}}</dd>
        <dt>Description</dt>
            <dd>{{ead.archdesc.odd.p}}</dd>
        <dt>Latest revision:</dt>
            <dd>{{ead.eadheader.revisiondesc.change.0.item}} - {{ead.eadheader.revisiondesc.change.0.date}}</dd>

    </dl>
    {{#ead.archdesc.dsc.c.0.c}}
        test
    {{/ead.archdesc.dsc.c.0.c}}
</script>
<script id="eadarchdescTpl" type="text/template">
    <h2>Description Template</h2>
    <dl class="dl-horizontal">
        <dt>Title:</dt><dd>{{ead.archdesc.dsc.c.0.c.0.did.unittitle}}</dd>
        <dt>Description:</dt><dd>{{odd.p}}</dd>
        <dt>adsfafadf:</dt><dd>{{dsc.c.c.0.series}}</dd>
    </dl>
</script>
<script id="testTmpl" type="text/template">
    <h2>Test Template</h2>
    <dl class="dl-horizontal">
        <dt>Title:</dt><dd>{{ead.archdesc.dsc.c.0.c.0.did.unittitle}}</dd>
        <dt>Description:</dt><dd>{{odd.p}}</dd>
        <dt>adsfafadf:</dt><dd>{{dsc.c.0.c.0.series}}</dd>
    </dl>
</script>
