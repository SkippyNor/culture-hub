#{extends 'header.html' /}
#{set title:_title /}

#{breadcrumbs /}

#{if browsedUserName}
<h2>Browse DataSets owned by: <span>${browsedUserName}</span> (${count})</h2>
#{/if}
#{else}
<h2>Browse DataSets (${count})</h2>
#{/else}

#{if items.length() > 0}
    <div class="data-grid">
        <table>
            <thead>
            <tr>
                <th>Name</th>
                <th>Nr. of items</th>
                <th>Status</th>
                <th>Options</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <td colspan="4">
                        #{if items.length() > 0}
                        <div id="pager">#{pagination selector: "#pager", count: count, start: page /}</div>
                        #{/}
                        #{else}
                        <p>There are currently no DataSets available</p>
                        #{/}
                </td>
            </tr>
            </tfoot>
            <tbody>
            #{list items, as: 'i'}
            <tr>
                <td><a href="/${i.userName}/dataset/${i.spec}">${i.spec}</a></td>
                <td>${i.total_records}</td>
                <td>${i.state.description()}</td>
                <td>
                  #{if i.userName == userName}
                      <a class="action edit image-edit" href="/${i.userName}/dataset/${i.spec}/update">Edit DataSet</a>
                      #{if i.state == models.DataSetState.UPLOADED()}
                      <form action="/${i.userName}/dataset/${i.spec}/index" method="POST">
                        <button class="action index">Index</button>
                      </form>
                      #{/if}
                      #{if i.state == models.DataSetState.ENABLED()}
                      <form action="/${i.userName}/dataset/${i.spec}/reindex" method="POST">
                        <button class="action reIndex">Re-Index</button>
                      </form>
                      <form action="/${i.userName}/dataset/${i.spec}/disable" method="POST">
                        <button class="action reIndex">Disable</button>
                      </form>
                      #{/if}
                      #{if i.state == models.DataSetState.QUEUED() || i.state == models.DataSetState.INDEXING()}
                      <form action="/${i.userName}/dataset/${i.spec}/cancel" method="POST">
                        <button class="action cancel">Cancel indexing</button>
                      </form>
                      #{/if}
                      #{if i.state == models.DataSetState.INDEXING()}
                        <div id="indexCounter${i.spec}"></div>
                        <script type="text/javascript">
                          $('#indexCounter${i.spec}').progressbar();
                          $('#indexCounter${i.spec}').smartupdater({
                            url : "/${i.userName}/dataset/${i.spec}/status",
                            minTimeout: 2000
                          }, function (data) {
                            var d = $.parseJSON(data);
                            if(d.state == 'DONE') {
                              $('#indexCounter${i.spec}').smartupdaterStop();
                              $('#indexCounter${i.spec}').progressbar("value", 100);
                              // TODO adjust message in table
                            } else {
                              $('#indexCounter${i.spec}').progressbar("value", d.state);
                            }
                          });
                        </script>
                      #{/if}
                    #{/if}
                </td>
            </tr>
            #{/list}
            </tbody>
        </table>
    </div>
        <a class="dui-button" href="/${userName}/sip-creator/">Sip-Creator</a>


#{/}
#{else}
    <p>There are currently no DataSets available</p>
#{/}