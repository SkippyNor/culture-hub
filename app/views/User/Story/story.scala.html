@(id: Option[String] = None)

@import views.context._
@import views.tags.html._

@header(if(id == None) "Create new story for user " + fullName else "Update story for user " + fullName) {

<div class="grid_16 alpha">
    <h1 class="emphasize">@if(id == None) { Create a new story } else { Update a story }</h1>
</div>

<div class="grid_5 alpha suffix_1">
    <h3>Step 1: Story Information</h3>
    <div class="container">
          <div class="head"></div>
          <div class="body">

              <p>
                  A <strong>story</strong> can be created from objects in a
                  <strong>collection</strong>. So before you can compose a story, you must have
                  a collection.
              </p>
              <ol>
                  <li>Enter the basic story information: a name and short description, and optionally add annotations</li>
                  <li>You should inititally keep the story publication status as "Private". Once you have your story as you like it you can come back and set the status to "Public" so that others may find and view it</li>
                  <li>Once you have completed the above steps you can start adding pages to your story</li>
              </ol>
          </div>
          <div class="foot"></div>
      </div>
</div>

<div class="grid_10 omega">

    <h2>Story Information</h2>
    <span class="required-note">* Required Fields</span>

    @textField("name", "Name", "value: name, valueUpdate: 'afterkeydown'")
    @textArea("description", "Description", "value: description, valueUpdate: 'afterkeydown'")

    <div class="field">
      <label for="public">Publication Status</label>
      <div class="inputs">
          <input type="radio" checked="checked" value="0" id="public-0" name="public"> Private
          <input type="radio" value="1" id="public-1" name="public"> Public
      </div>
    </div>

    <div class="actions">
        <button class="add page-add" id="btn-add-pages" data-bind="enable: name().length > 0 && description().length > 0, click: addPages">Add Page(s)</button>
    </div>

</div>

<div class="clear"></div>

<div id="story-pages" style="display: none">
    <hr/>
    <div class="grid_5 alpha suffix_1">
        <h3>Step 2: Story Pages</h3>
        <div class="container">
            <div class="head"></div>
            <div class="body">
                <ol>
                    <li>Enter a page title</li>
                    <li></li>
                </ol>
            </div>
        </div>
    </div>
    <div class="grid_10 omega">
        <h2>Story Pages</h2>

        <p id="no-pages-found" data-bind="visible: pages().length == 0">No pages found</p>
        <div id="page-list" data-bind="template: 'pageList', visible: pages().length > 0"></div>

        <div class="actions">
                <button class="add page-add" id="btn-add-page" data-bind="click: function() { this.addPage(); }">Add a new page</button>
        </div>

        <div id="form-add-page" class="page-form" style="display: none;" data-bind="template: {name: 'pageTemplate', templateOptions: {action: 'New'}}"></div>

    </div>

</div>
<!-- // story-pages -->




<div class="grid_16 alpha" id="save-story">
<hr/>
    <div class="actions">
      <div class="wait"></div>
      <button class="save" data-bind="enable: name().length > 0 && description().length > 0, click: saveTheStory">Save Story</button>
    </div>
</div>

<div class="objects-container" id="objects-dialogue" title="Select Object(s)">
  <div id="objects-list" data-bind="template: 'availableObjectsList'"></div>
</div>

<div id="dialog-confirm-page-delete" title="Delete the page?" style="display: none;">
	<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Are you sure you want to delete this page?</p>
</div>

<script id='delving-wysiyg' src='@asset("/public/themes/common/javascripts/tiny_mce/tiny_mce.js")' type='text/javascript'></script>

<script type="text/html" id="pageTemplate">
  <form id="${$item.action}PageForm" action="">

    <h3>${$item.action} Page</h3>
    <span class="required-note">* Required Fields</span>

    <div class="field">
      <label for="title">Title</label>
      <div class="inputs">
        <input type="text" class="textinput" id="title" name="title" size="40" data-bind="value: currentPage.title, valueUpdate: 'afterkeydown' " />
        <span class="error"></span>
        <span class="help"></span>
      </div>
    </div>

    <div class="field">
        <label for="page-text" class="required">Free Text</label>
        <div class="inputs">
            <textarea class="textinput mceEditor" name="page-text" id="page-text" data-bind="tinymce: currentPage.text"></textarea>
            <span class="error"></span>
        </div>
    </div>

    <div class="field">
        <div class="inputs">
            <select id="collection-name" name="collection-name" data-bind="options: collections(), optionsCaption: 'Choose...', optionsText: 'name', optionsValue: 'id', event: { change: collectionChanged }"></select>
            <button class="add image-add" id="addObject" data-bind="enable: currentPage.availableObjects().length > 0, click: function() { $('#objects-dialogue').dialog('open'); }">Add an image from this collection</button>
        </div>
        <div id="objectList" class="display-box" data-bind="template: 'objectsList'"></div>
    </div>
    <div class="field">
        <div class="inputs">
            <button class="save page-save"  type="submit" data-bind="click: saveCurrentPage">Save Page</button>
        </div>
    </div>
  </form>

</script>

<script type="text/html" id="availableObjectsList">
  <table>
      <tbody>
      {{each(i, object) currentPage.availableObjects()}}
      <tr>
          <td><input type="checkbox" value="${object.id}" data-bind="checked: currentPage.selectedObjectIds()" /></td>
          <td><img src='${thumbnailUrl(object.id)}' width="50" alt="${object.name}"/></td>
          <td><h4>${object.name}</h4></td>
      </tr>
      {{/each}}
      </tbody>
  </table>
</script>

<script type="text/html" id="objectsList">
  <ul>
  {{each(i, object) currentPage.objects()}}
  <li>
    ${object.name} (<a href="#" data-bind="click: function() { this.removeObject(object) }">Remove</a>)
  </li>
  {{/each}}
  </ul>
</script>

<script type="text/html" id="pageList">
  <ul class="page-list">
      {{each(i, page) pages()}}
      <li id="page-${i}">
          <div class="page-info">
              <span class="left">
                  <span class="page-title">${page.title}</span>
              </span>
              <span class="right">
                  <span class="page-edit"><a class="edit" href="#" data-bind="click: function() { this.editPage(page); }">Edit</a></span>
                  <span class="page-delete"><a class="delete" href="#" data-bind="click: function() { this.deletePage(page); }">Delete</a></span>
              </span>
          </div>
      </li>
      {{/each}}
  </ul>
  <div class="clear"></div>
  <p class="developers-note ui-state-error ui-corner-all">
    <span class="ui-icon ui-icon-alert"></span>
    Pages in the above list should be 'draggable' to re-order. Clicking on 'Edit' would fill and show the form below.
    Clicking 'Delete' removes the page.
  </p>
</script>


<script type="text/javascript" language="javascript">

    $(document).ready(function() {
      var storyModel = {
        currentPage: {
          isNew: ko.observable(false),
          pageRef: ko.observable(),
          title: ko.observable(),
          text: ko.observable(),
          objects: ko.observableArray(),
          selectedCollection: ko.observable(),
          availableObjects: ko.observableArray(),
          selectedObjectIds: ko.observableArray()
        },
        addPages: function() {
          saveStory();
          $("#story-pages").show("slow");
        },
        addPage: function() {
          storyModel.currentPage.lock = true;
          storyModel.currentPage.isNew(true);
          storyModel.currentPage.title("");
          storyModel.currentPage.text("");
          storyModel.currentPage.objects([]);
          storyModel.currentPage.selectedCollection([]);
          storyModel.currentPage.availableObjects([]);
          storyModel.currentPage.selectedObjectIds([]);
          $("#form-add-page").show("slow");
        },
        editPage: function(page) {
          storyModel.currentPage.isNew(false);
          storyModel.currentPage.pageRef(page),
          storyModel.currentPage.title(page.title());
          storyModel.currentPage.text(page.text());
          storyModel.currentPage.objects(page.objects());
          storyModel.currentPage.selectedCollection([]);
          storyModel.currentPage.selectedObjectIds([]);
          storyModel.currentPage.availableObjects([]);
          $("#form-add-page").show("slow");
        },
        deletePage: function(page) {
          confirmDeletion('#dialog-confirm-page-delete', function() {
            var idx;
            storyModel.pages.remove(function(item) {
              return item.title === page.title && item.text === page.text;
            });
            saveStory(null, function() {
            // TODO cry, in despair, and yell.
            });
          });
        },
        removeObject: function(object) {
          storyModel.currentPage.objects.remove(object);
          storyModel.currentPage.availableObjects.push(object);
        },
        saveCurrentPage: function() {
          if(storyModel.currentPage.isNew()) {
            this.pages.push(ko.toJS(storyModel.currentPage));
          } else {
            // find the page and update it
            var p = ko.toJS(storyModel.currentPage);
            storyModel.currentPage.pageRef().title(p.title);
            storyModel.currentPage.pageRef().text(p.text);
            storyModel.currentPage.pageRef().objects(p.objects);
          }
          storyModel.currentPage.lock = false;
          saveStory(function() {
            $('#pageForm').resetForm();
            $("#form-add-page").hide("slow");
          }, function() {
            // TODO yell, cry. be desperate
              alert("fpp");
          });
        },
        collectionChanged: function() {
          storyModel.currentPage.availableObjects.removeAll();
          if($('#collection-name').val().length > 0) {
            $.getJSON('/@userName/collection/' + $('#collection-name').val() + '/objects', {}, function(data) {
              $.each(data, function(index, obj) {
                if(storyModel.currentPage.objects.indexOf(obj) < 0) {
                  storyModel.currentPage.availableObjects.push(obj);
                }
              });
            });
          }
        },
        saveTheStory: function() {
          saveStory(function() {
            window.location.href = '/@userName/story/' + storyModel.id()
          }, function() {
            // TODO yell, shout, be desperate
          }, false);
        }
      };
      load('/@userName/story/load/@id.getOrElse("")', storyModel);

      $('#objects-dialogue').dialog({
        autoOpen: false,
        modal: true,
        buttons: {
          "Add selected objects": function() {
            addSelectedObjects(storyModel.currentPage.objects, storyModel.currentPage.selectedObjectIds, storyModel.currentPage.availableObjects);
            $(this).dialog('close');
          }
        }
      });

      function saveStory(onSuccess, onFailure, isDraft) {
        var draft = typeof isDraft === 'undefined' ? false : isDraft;
        storyModel.isDraft(draft);
        Spinners.create('.wait').play();
        $.postKOJson('/@userName/story/submit', storyModel, function(data) {
          Spinners.get('.wait').remove();
          updateViewModel(data, storyModel);
          if(onSuccess !== undefined && typeof onSuccess === 'function') onSuccess.call();
        }, function(jqXHR, textStatus, errorThrown) {
          Spinners.get('.wait').remove();
          if(onFailure !== undefined && typeof onFailure === 'function') onFailure.call();
        })
      }
    });

    $(window).load(function() {
        Delving.wysiwyg();
    });
</script>
}