#{set 'visibility'}hidden#{/}
#{extends themeInfo.get('themeLayout') /}
#{set title: messages.get('organization.dataset.create') /}
#{set bodyId: 'organization' /}
#{breadcrumbs /}

#{organizationNavBar
orgId: orgId,
active:"datasets",
extraButtons: [
[label:messages.get('ui.label.sipcreator'), url:"/organizations/"+orgId+"/sip-creator"],
[label: messages.get('organization.dataset.create'), url:"/organizations/"+orgId+"/dataset/add", extraClass:"action complete", visible: isOwner]
],
isOwner: isOwner /}
<div class="row">
    <div class="grid_12 dashboard">
        <h1 class="sep">${spec.isEmpty() ? messages.get('organization.dataset.create') : messages.get('organization.dataset.update') }</h1>

        <form method="post" action="" id="collectionForm">
            <div class="row">
                <div class="g-1of2">
                    <h3>&{'organization.dataset.info'}</h3>
                    #{textField name:"spec", form: dataSetForm, label: messages.get('organization.dataset.label.identifier'), dataBind:"value: spec", help: messages.get('organization.dataset.help.identifier') /}
                    <div class="field">
                        <label class="label">&{'ui.label.visibility'}</label>

                        <div class="inputs">
                            <input type="radio" name="public" value="${models.Visibility.PRIVATE().value}" data-bind="checked: visibility"/>&{'ui.label.visibility.notpublic'}
                            <br/>
                            <input type="radio" name="public" value="${models.Visibility.PUBLIC().value}" data-bind="checked: visibility"/>&{'ui.label.visibility.public'}
                        </div>
                    </div>

                    %{for(i in 0..factDefinitions.size() - 1) {
                    def factDef = factDefinitions.apply(i);
                    }%
                    #{if factDef.hasOptions()}
                    #{populatedSelectField name: "facts." + factDef.name, form: dataSetForm, label: factDef.prompt, options: factDef.opts, dataBind: "value: facts." + factDef.name, help: factDef.tooltip /}
                    #{/if}
                    #{else}
                    #{textField name: "facts." + factDef.name, form: dataSetForm, label: factDef.prompt, dataBind: "value: facts." + factDef.name, help: factDef.tooltip, isDisabled: factDef.automatic /}
                    #{/else}

                    %{ }}%
                </div>
                <div class="g-1of2">
                    <h3>Target Record Definitions</h3>
                    #{list recordDefinitions, as: 'recordDef'}
                    #{checkboxField name: recordDef + "_field", label: recordDef, value: recordDef, dataBind: "checked: recordDefinitions" /}
                    #{/list}
                    <h3>Indexing Mapping Record Definition</h3>
                    <select id="mapping-prefix" name="mapping-prefix" data-bind="options: recordDefinitions, optionsCaption: 'Select a mapping for indexing', value: indexingMappingPrefix"></select>
                    <span class="error" data-bind="text: errors().indexingMappingPrefix"></span>
                </div>
            </div>
            <div class="row">
                <div class="buttons">
                    #{btnHref id:"saveButton", name:"saveButton", label:messages.get('organization.dataset.save'), extraClass:"submit"/}
                </div>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        $(document).ready(function() {
            var dataSetModel = {};

            $('#saveButton').click(function(event) {
                event.preventDefault();
                handleSubmit('/organizations/${orgId}/dataset/submit', dataSetModel, '#collectionForm', null, function() {
                    window.location.href = '/organizations/${orgId}/dataset/' + dataSetModel.spec.call();
                });
            });

            load(${data.raw()}, dataSetModel, null, function() {
                $("body").css('visibility', 'visible');
            });
        });
    </script>