#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.dataset') + ' ' + dataSet.name + ' - ' + messages.get('thing.organization') + ': ' + orgId /}
#{set bodyId: 'organization' /}
#{breadcrumbs /}

<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/organizations/datasets.js")}"></script>

#{organizationNavBar orgId: orgId, active:"datasets", navigation: navigation /}

<div class="row">
    <div class="span4">

        <table class="table table-condensed table-wrap">
            <caption>Basic information</caption>
            <tbody>
                <tr>
                    <th>&{'thing.creator'}</th>
                    <td><span data-bind="text: creator"></span></td>
                </tr>
                <tr>
                    <th>Spec (Identifier)</th>
                    <td><span data-bind="text: spec"></span></td>
                </tr>
                <tr>
                    <th>Name</th>
                    <td data-bind="text: name"></td>
                </tr>
                <tr>
                    <th>Language</th>
                    <td data-bind="text: information.language"></td>
                </tr>
                <tr>
                    <th>Country</th>
                    <td data-bind="text: information.country"></td>
                </tr>
                <tr>
                    <th>Provider</th>
                    <td data-bind="text: nodeName"></td>
                </tr>
                <tr>
                    <th>Data Provider</th>
                    <td data-bind="text: information.dataProvider"></td>
                </tr>
                <tr>
                    <th>Rights</th>
                    <td data-bind="text: information.rights"></td>
                </tr>
                <tr>
                    <th>Type</th>
                    <td data-bind="text: information.type"></td>
                </tr>
            </tbody>
        </table>

        <table class="table table-condensed">
            <caption>Processing configuration</caption>
            <thead>
            <tr>
                <th>Output schema</th>
                <th>Access rights</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: harvestingConfiguration">
            <tr>
                <td><span class="label" data-bind="text: schema"></span></td>
                <td><span data-bind="text: accessType"></span></td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td colspan="2">
                #{if get('spec')}
                    <a class="btn" href="/organizations/${orgId}/dataset/${get('spec')}/update"><i class="icon icon-edit"></i> ${messages.get('ui.label.edit')}</a>
                #{/if}
                </td>
            </tr>
            </tfoot>
        </table>

        <table class="table table-condensed">
            <caption>Indexing and rendering schema</caption>
            <tr>
                <td><span data-bind="text: indexingSchema"></span></td>
            </tr>
        </table>
    </div>


    <div class="span8">

        <table class="table table-condensed">
            <caption>Status information</caption>
            <thead>
            <tr>
                <th>State</th>
                <th>Total records</th>
                <th>Valid <span class="label">ese</span></th>
                <th>Valid <span class="label">icn</span></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><span class="badge badge-success">Enabled</span></td>
                <td><span data-bind="text: totalRecords"></span></td>
                <td>54200</td>
                <td>54540</td>
            </tr>
            </tbody>
        </table>
        <!-- 2nd alert class (alert-...) determined by state of dataset -->
        <div class="alert alert-success">
            Dataset is enabled and functioning properly.
        </div>
        *{<div class="alert alert-error">}*
            *{Complete stack trace of dataset error state (Hmmm, something is wrong)}*
        *{</div>}*
        *{<div class="alert alert-info">}*
            *{Other information that may be useful to display}*
        *{</div>}*
            <h4>Dataset actions</h4>
        <div class="panel panel-focus">

            <div class="btn-toolbar">
                <div class="btn-group">
                    <button class="btn disabled">Enable</button>
                    <button class="btn">Disable</button>
                    <button class="btn">Process</button>
                </div>
                <div class="btn-group">
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        Expert actions
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="#"><i class="icon icon-lock"></i> Unlock</a></li>
                        <li><a href="#"><i class="icon icon-warning-sign"></i> Reset Hashes</a></li>
                        <li><a href="#"><i class="icon icon-remove"></i> Delete</a></li>
                    </ul>

                *{<button class="btn">Unlock</button>}*
                *{<button class="btn">Delete</button>}*
                *{<button class="btn">Reset hashes</button>}*
                </div>
            </div>

            <h5>Action progress</h5>
            <div class="progress active">
                <div class="bar" style="width: 66%;"></div>
            </div>
        </div>

    </div>
</div>
<div class="row">
*{<div class="span12">}*
        *{#{if canEdit}}*
        *{<div class="well">}*
            *{#{if get('spec')}}*
            *{<a class="btn btn-primary btn-mini" href="/organizations/${orgId}/dataset/${get('spec')}/update">${messages.get('ui.label.edit')}</a>}*
            *{#{/if}}*
            *{<a class="btn btn-mini" href="/organizations/${orgId}/dataset">&{'organization.dataset.list'}</a>}*
        *{</div>}*
        *{#{/if}}*
    *{</div>}*
</div>




<script type="text/javascript" language="javascript">
    $(document).ready(function () {

        var viewModel = {
            stateToClass: function(state) { return stateToClass(state); }
        };

        var clientId = Math.floor(1 + 10001 * Math.random());
        var ws = new WebSocket("ws://" + location.host + "/organizations/${orgId}/dataset/feed?clientId=" + clientId + '&spec=${dataSet.spec}');

        ws.onopen = function() {
            console.log("WebSockets connection opened");
            ws.send(JSON.stringify({
                eventType: "sendSet",
                clientId: clientId,
                payload: '${dataSet.spec}'
            }));
        };

        ws.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);
            console.log(data);
            switch(data.eventType) {
                case "loadSet":
                    $.extend(viewModel, ko.mapping.fromJS(data.payload));
                    ko.applyBindings(viewModel);
                    break;
                case "updated":
                    break;
                case "removed":
                    break;
                case "sourceRecordCountChanged":
                    viewModel.totalRecords(data.payload);
                    break;
                case "stateChanged":
                    viewModel.state(data.payload);
                    break;
                case "locked":
                    viewModel.lockState("locked");
                    viewModel.lockedBy(data.payload);
                    break;
                case "unlocked":
                    viewModel.lockState("unlocked");
                    viewModel.lockedBy("");
                    break;
            }
        };

        ws.onclose = function() {
            console.log("WebSockets connection closed");
        };

    });

</script>


