#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.browse.of', messages.get('thing.datasets')) + ': ' + orgId /}

#{set 'moreScripts'}
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/jquery.tablesorter.min.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/jquery.uitablefilter.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/smartupdater.4.0.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/bootstrap/bootstrap-popover.js")}"></script>
#{/set}

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", navigation: navigation /}

<div class="row">

    *{<div class="span4">}*
        *{<form class="form-inline pull-left">}*
            *{<h4>&{'dataset.filter.state'}:</h4>}*
            *{<input type="checkbox" name="filter-state" value="">}*
            *{<label for="dataset-state-x">state-x</label>}*
            *{<input type="checkbox" name="filter-state" value="">}*
            *{<label for="dataset-state-x">state-y</label>}*
            *{<input type="checkbox" name="filter-state" value="">}*
            *{<label for="dataset-state-x">state-z</label>}*
        *{</form>}*
    *{</div>}*
    <div class="span8">
        <form id="filter-form" class="form-inline pull-left">
            <!-- todo: update message to "Filter by name" -->
            *{<h4>&{'dataset.filter.name'}: </h4>}*
            <input type='text' name='filter' id='filter' maxlength="30" size="30" class="textinput" placeholder=""/>
            <input onclick="saveFilter()" class="btn" type="button" value="Pin"/>
            <input onclick="resetFilter()" class="btn" type="reset" value="&{'ui.label.reset'}"/>
            <br/><span class="help-inline">Type in any dataset value(s) to filter the table. Press "Pin" to save the filter.</span>

        </form>
    </div>

<div class="span12">
    <table id="dataset-table" class="table table-striped sortable">
        <caption>${messages.get('thing.datasets')}</caption>
        <thead>
        <tr>
            <th class="sort">&{'thing.name'}</th>
            <th class="sort">&{'thing.provider'}</th>
            <th class="sort">&{'ui.label.nritems'}</th>
            <th class="sort">&{'ui.label.state'}</th>
            <th class="sort">&{'ui.label.availability'}</th>
            <th>&{'ui.label.options'}</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <td colspan="5">
            <!-- ko if: sets().length == 0 -->
                ${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}
            <!-- /ko -->
            </td>
        </tr>
        </tfoot>
        <tbody data-bind="foreach: sets()">
            <tr>
                <td><a data-bind="attr: { href: '/organizations/' + orgId + '/dataset/' + spec }"><i class="icon icon-wrench"></i> <span data-bind="text: spec"></span></a></td>
                <td><span data-bind="text: nodeName"></span></td>
                <td>
                    <a data-bind="text: totalRecords, attr: { href: '/search?query%3Ddelving_spec%3A' + spec, title: 'Record counts ' + spec }" class="rCount"></a>

                    <div class="schema-count" style="display: none;">
                        <table class="table table-condensed">
                            <tr>
                                <th>Schema</th>
                                <th>Valid records</th>
                            </tr>
                            <tr>
                                <td><span class="label">ese</span></td>
                                <td data-bind="text: totalRecords"></td>
                            </tr>
                            <tr>
                                <td><span class="label">icn</span></td>
                                <td>25456</td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td width="120">

                    <!-- TODO use state description from i18n file, somehow-->
                    <!-- ko if: state == "error" -->
                    <span class="badge badge-important badge-error" data-bind="attr: { 'data-original-title': state}" rel="popover"></span>
                    <!-- /ko -->
                    <!-- ko ifnot: state == "error" -->
                    <span data-bind="text: state, attr: { class: 'badge ' + $parent.stateToClass(state) } "></span>
                    <!-- /ko -->


                </td>
                <td>
                    <!-- ko if: lockState == 'locked' -->
                    LockedBy (<span data-bind="text: lockedBy"></span>)
                    <!-- /ko -->
                    <!-- ko if: lockState != 'locked' -->
                    <span class="badge badge-info">&{'dataset.lockstatus'}</span>
                    <!-- /ko -->
                </td>
                <td>
                    #{if isAdmin}
                        <a data-bind="href: { href: '/organizations/' + orgId + '/dataset/' + spec + '/update' }">
                            <i class="icon icon-edit"></i> ${messages.get('ui.label.edit')}
                        </a>
                    #{/if}
                </td>

            </tr>
        </tbody>
    </table>

    <!-- ko ifnot: sets().length > 0 -->
    <p>${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}</p>
    <!-- /ko -->
</div>
</div>

<script type="text/javascript" language="javascript">
    $(document).ready(function () {

        var viewModel = {
            sets: ko.observableArray(),
            stateToClass: function(state) {
                var stateClass = "";
                switch(state) {
                    case "uploaded":
                        stateClass = "uploaded";
                        break;
                    case "incomplete":
                        stateClass = "incomplete";
                        break;
                    case "error":
                        stateClass = 'error';
                        break;
                    case "enabled":
                        stateClass = 'enabled';
                        break;
                    case "disabled":
                        stateClass = 'disabled';
                        break;
                    case "processing":
                        stateClass = 'processing';
                        break;
                    case "queued":
                        stateClass = 'queued';
                        break;
                    case "parsing":
                        stateClass = 'parsing';
                        break;
                    default:
                        stateClass = "";
                        break
                }

                return "badge-" + stateClass;
            }
        };

        var clientId = Math.floor(1 + 10001 * Math.random());
        var ws = new WebSocket("ws://" + location.host + "/organizations/${orgId}/dataset/feed?clientId=" + clientId);

        ws.onopen = function() {
            console.log("WebSockets connection opened");
            ws.send(JSON.stringify({
                eventType: "sendList",
                clientId: clientId
            }));
        };

        ws.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);
            console.log(data);
            switch(data.eventType) {
                case "loadList":
                    viewModel.sets(data.list);
                    break;
            }
        };

        ws.onclose = function() {
            console.log("WebSockets connection closed");
        };

        ko.applyBindings(viewModel);

        console.log($.cookie("ds-filter"));
    });

</script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/organizations/datasets-list.js")}"></script>