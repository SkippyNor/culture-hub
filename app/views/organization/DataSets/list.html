#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.browse.of', messages.get('thing.datasets')) + ': ' + orgId /}

#{set 'moreScripts'}
<script type="text/javascript" xmlns="http://www.w3.org/1999/html"
        src="@{routes.Assets.at("common/javascripts/jquery.tablesorter.min.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/jquery.uitablefilter.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/smartupdater.4.0.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/bootstrap/bootstrap-popover.js")}"></script>
#{/set}

*{#{set 'moreCss'}}*
*{<link rel="stylesheet" type="text/css" href="@{routes.Assets.at("common/stylesheets/bootstrap/bootstrap-responsive.css")}"/>}*
*{#{/set}}*

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", navigation: navigation /}

<div class="row">


*{#{if browsedUserName}}*
*{<div class="row">}*
*{&{'thing.organization'}: <span>${browsedOrgName}</span><br/>}*
*{&{'thing.count'}: ${count}}*
*{</div>}*
*{#{/if}}*

#{if items.length() > 0}

*{<div class="well">}*

    <div class="span4">
        <form class="form-inline pull-left">
            <h4>&{'dataset.filter.state'}:</h4>
            <input type="checkbox" name="filter-state" value="">
            <label for="dataset-state-x">state-x</label>
            <input type="checkbox" name="filter-state" value="">
            <label for="dataset-state-x">state-y</label>
            <input type="checkbox" name="filter-state" value="">
            <label for="dataset-state-x">state-z</label>
        </form>
    </div>
    <div class="span4">
        <form id="filter-form" class="form-inline pull-left">
            <!-- todo: update message to "Filter by name" -->
            <h4>&{'dataset.filter.name'}: </h4>
            <input type='text' name='filter' id='filter' maxlength="30" size="30" class="textinput"
                   placeholder="&{'dataset.filter.beginTyping'}"/>
            <input onclick="resetFilter()" class="btn" type="reset" value="&{'ui.label.reset'}"/>

        </form>


    </div>



*{</div>}*
<div class="span12">
    <table id="dataset-table" class="table table-striped sortable">
        <caption>${messages.get('thing.datasets')}</caption>
        <thead>
        <tr>
            <th class="sort">&{'thing.name'}</th>
            <th class="sort">&{'thing.provider'}</th>
            <th class="sort">&{'ui.label.nritems'}</th>
            <th class="sort">&{'ui.label.state'}</th>
            <th class="sort">&{'ui.label.availability'}</th>
            <th>&{'ui.label.options'}</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <td colspan="5">
                #{ifnot items.length() > 0}
                    {messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}
                #{/ifnot}
            </td>
        </tr>
        </tfoot>
        <tbody>

            #{list items, as: 'i'}
            <tr>
                <td><a href="/organizations/${orgId}/dataset/${i.spec}"><i class="icon icon-wrench"></i> ${i.spec}
                </a></td>
                <td>Organization name</td>
                <td>
                    <a href="/search?query=delving_spec%3A${i.spec}"
                       title="Record counts ${i.spec}" class="rCount">${i.total_records}</a>
                       <div class="schema-count" style="display: none;">
                           <table class="table table-condensed">
                               <tr>
                                   <th>Schema</th><th>Valid records</th>
                               </tr>
                               <tr>
                                   <td><span class="label">ese</span></td><td>23342</td>
                               </tr>
                               <tr>
                                   <td><span class="label">icn</span></td><td>25456</td>
                               </tr>
                           </table>
                       </div>
                </td>
                <td id="description${i.spec}" width="120">
                *{ todo: get list of all dataset states and create css defs (color) for them }*
                    #{if i.state.name() == models.DataSetState.ERROR().name()}
                        <span class="badge badge-important badge-error" rel="popover"
                              data-original-title="${i.state.description()}"
                              data-content="${i.error.raw()}">&{'ui.label.error'}</span>
                    #{/if}
                    #{else}
                        <span class="badge badge-success">${i.state.description()}</span>
                    #{/else}
                </td>
                <td>
                    #{ifnot i.lockedBy.isEmpty()}
                        <a class="btn btn-warning btn-mini" id="unlock${i.spec}">
                        ${messages.get('ui.label.unlock')} (${i.lockedBy.get()})
                        </a>
                        <script type="text/javascript">
                            $(document).ready(function () {
                                $('#unlock${i.spec}').click(function () {
                                    $.ajax({
                                        url:'/organizations/${orgId}/dataset/${i.spec}/forceUnlock',
                                        type:'POST',
                                        complete:function () {
                                            document.location = "/organizations/${orgId}/dataset";
                                        }
                                    });
                                });
                            });
                        </script>
                    #{/ifnot}
                    #{else}
                    <span class="badge badge-info">&{'dataset.lockstatus'}</span>
                    #{/else}
                </td>
                <td>
                    #{if isAdmin}
                    <div class="btn-toolbar nom">
                    *{<div class="btn-group">}*
                        <a class="" href="/organizations/${orgId}/dataset/${i.spec}/update">
                            <i class="icon icon-edit"></i> ${messages.get('ui.label.edit')}
                        </a>
                    *{</div>}*


                    #{/if}
                </div>
                </td>

            </tr>
            #{/list}
        </tbody>
    </table>
#{/}
#{else}
    <p>${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}</p>
#{/}
</div>
</div>

<script type="text/javascript" language="javascript">
    $(document).ready(function () {

        var viewModel = {
            "sets": ko.observableArray()
        };

        var clientId = Math.floor(1 + 10001 * Math.random());

        var ws = new WebSocket("ws://" + location.host + "/organizations/${orgId}/dataset/feed?clientId=" + clientId);

        ws.onopen = function() {
            console.log("WebSockets connection opened");
            ws.send(JSON.stringify({
                eventType: "sendList",
                clientId: clientId
            }));
        };

        ws.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);
            console.log(data);
            switch(data.eventType) {
                case "loadList":
                    viewModel.sets(data.list);
                    break;
            }
        };

        ws.onclose = function() {
            console.log("WebSockets connection closed");
        };

        ko.applyBindings(viewModel);

        $("#dataset-table").tablesorter();
        var theTable = $('#dataset-table');
        theTable.find("tbody > tr").find("td:eq(1)").mousedown(function () {
            $(this).prev().find(":checkbox").click();
        });

        $("#filter").keyup(function () {
            $.uiTableFilter(theTable, this.value);
        });

        $('#filter-form').submit(
                function () {
                    theTable.find("tbody > tr:visible > td:eq(1)").mousedown();
                    return false;
                }).focus(); //Give focus to input field
        $('.badge-error').popover({
            placement: 'right'
        });
        $('.rCount').each(function(){
            var $pElem = $(this);
            $pElem.popover({
                content: $(this).next('.schema-count').html()
            })
        })

    });

    function resetFilter() {
        $.uiTableFilter($('#dataset-table'), '');
        $('input#filter').val('');
    }

</script>